<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>DRS-ONE</title>
    <!-- Using Compat version for maximum reliability in iframe/preview environments -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <style>
        :root {
            --drs-bg: #000000;
            --drs-card: #0a0a0b;
            --drs-accent: #0070f3;
            --drs-text: #ffffff;
            --drs-text-dim: #666666;
            --drs-border: #1a1a1a;
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0; padding: 0;
            background: var(--drs-bg);
            color: var(--drs-text);
            font-family: -apple-system, BlinkMacSystemFont, "Inter", sans-serif;
            min-height: 100vh;
            display: flex; flex-direction: column;
            overflow: hidden;
        }

        /* Views */
        .view {
            display: none; width: 100%; max-width: 480px; margin: 0 auto;
            padding: calc(2rem + var(--safe-top)) 1.5rem calc(6rem + var(--safe-bottom));
            flex: 1; overflow-y: auto;
        }

        /* Auth Screen */
        .auth-container { height: 100vh; display: flex; align-items: center; justify-content: center; }
        .auth-box { width: 100%; text-align: center; padding: 2rem; }

        /* UI Elements */
        .drs-card {
            background: var(--drs-card); border: 1px solid var(--drs-border);
            border-radius: 8px; padding: 1.5rem; margin-bottom: 1rem;
        }
        .label { font-size: 10px; font-weight: 800; color: var(--drs-text-dim); text-transform: uppercase; letter-spacing: 2px; margin-bottom: 8px; display: block; }
        
        input {
            width: 100%; padding: 12px; border-radius: 4px; border: 1px solid var(--drs-border);
            background: #000; color: #fff; font-size: 14px; margin-bottom: 12px;
        }
        input:focus { border-color: var(--drs-accent); outline: none; }

        .btn {
            width: 100%; padding: 14px; border-radius: 4px; border: none; font-size: 12px;
            font-weight: 700; text-transform: uppercase; letter-spacing: 1px; cursor: pointer;
            display: flex; align-items: center; justify-content: center; transition: opacity 0.2s;
        }
        .btn-primary { background: var(--drs-accent); color: #fff; }
        .btn-ghost { background: transparent; color: #fff; border: 1px solid var(--drs-border); }
        .btn:active { opacity: 0.7; }

        /* HUD Navigation */
        .bottom-nav {
            position: fixed; bottom: calc(1rem + var(--safe-bottom)); left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 400px; background: rgba(10,10,11,0.9);
            border: 1px solid var(--drs-border); border-radius: 12px;
            display: none; grid-template-columns: repeat(3, 1fr); padding: 6px; z-index: 1000;
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
        }
        .nav-item {
            text-align: center; padding: 12px 0; font-size: 10px; font-weight: 800;
            text-transform: uppercase; color: var(--drs-text-dim); cursor: pointer;
        }
        .nav-item.active { color: var(--drs-accent); }

        /* Loader Overlay */
        #loader {
            position: fixed; inset: 0; background: #000; z-index: 9999;
            display: flex; align-items: center; justify-content: center;
        }
        .spin { width: 24px; height: 24px; border: 2px solid #333; border-top-color: var(--drs-accent); border-radius: 50%; animation: s 0.6s linear infinite; }
        @keyframes s { to { transform: rotate(360deg); } }

        .media-box { position: relative; padding-bottom: 56.25%; height: 0; border: 1px solid var(--drs-border); margin-top: 10px; }
        .media-box iframe { position: absolute; inset: 0; width: 100%; height: 100%; border: none; }
        
        .toast {
            position: fixed; top: 2rem; left: 50%; transform: translateX(-50%);
            background: #fff; color: #000; padding: 8px 20px; border-radius: 4px;
            font-size: 11px; font-weight: 900; text-transform: uppercase; z-index: 10001; display: none;
        }
    </style>
</head>
<body>

    <div id="loader"><div class="spin"></div></div>

    <!-- LOGIN -->
    <div id="view-login" class="view auth-container">
        <div class="auth-box">
            <h1 style="letter-spacing: 12px; font-weight: 900; margin: 0;">DRS-ONE</h1>
            <p style="color: var(--drs-text-dim); font-size: 10px; letter-spacing: 4px; margin-top: 10px; margin-bottom: 40px;">COMMAND SYSTEM</p>
            <div class="drs-card" style="text-align: left;">
                <span class="label">Access Key</span>
                <input type="text" id="user-in" placeholder="ID">
                <input type="password" id="pass-in" placeholder="PASS">
                <button class="btn btn-primary" id="login-trigger">Initialize</button>
                <div id="auth-err" style="color:red; font-size:10px; text-align:center; margin-top:15px; display:none;">ACCESS DENIED</div>
            </div>
        </div>
    </div>

    <!-- TRAVELER HOME -->
    <div id="view-home" class="view">
        <header style="margin-bottom: 2rem;">
            <span class="label">Primary Node Location</span>
            <h2 id="loc-display" style="font-weight: 300; margin: 0;">SYNCHRONIZING...</h2>
        </header>
        <div id="alert-zone"></div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <div class="drs-card">
                <span class="label">Thermal</span>
                <div id="temp-display" style="font-size: 24px; font-weight: 200;">--</div>
            </div>
            <div class="drs-card">
                <span class="label">Status</span>
                <div id="weather-display" style="font-size: 11px; font-weight: 800; padding-top: 8px;">ACTIVE</div>
            </div>
        </div>
        <div class="drs-card">
            <span class="label">External Intel Stream</span>
            <div id="media-wrap"><p style="font-size:10px; color:#444; text-align:center; padding: 20px;">NODE IDLE</p></div>
        </div>
    </div>

    <!-- TRAVELER UPLINK -->
    <div id="view-uplink" class="view">
        <span class="label">Data Logistics</span>
        <div class="drs-card" style="text-align: center; padding: 40px 20px;">
            <button class="btn btn-primary" id="gps-trigger">Push Coordinates</button>
            <p id="ping-ts" style="font-size: 9px; color: var(--drs-text-dim); margin-top: 20px; font-weight: 800;">LINK READY</p>
        </div>
        <div class="drs-card">
            <span class="label">Manual Log Entry</span>
            <input type="text" id="log-in" placeholder="Message content...">
            <button class="btn btn-ghost" id="log-trigger">Commit</button>
        </div>
    </div>

    <!-- SYSTEM CONFIG -->
    <div id="view-config" class="view">
        <span class="label">Core Config</span>
        <div class="drs-card">
            <span class="label">Playlist Integration</span>
            <input type="text" id="yt-in" placeholder="YOUTUBE_ID">
            <button class="btn btn-primary" id="config-save">Save Config</button>
        </div>
        <button class="btn" style="color:red; font-size:10px; border:1px solid #300;" onclick="logout()">Terminate Session</button>
    </div>

    <!-- WATCHER MONITOR -->
    <div id="view-monitor" class="view">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
            <h2 style="font-size: 14px; font-weight: 900; letter-spacing: 2px;">DRS-MONITOR</h2>
            <button class="btn btn-ghost" style="width:auto; padding: 5px 12px; font-size: 9px;" onclick="logout()">EXIT</button>
        </div>
        <div id="monitor-stream"></div>
    </div>

    <nav class="bottom-nav" id="hud">
        <div class="nav-item active" onclick="nav('home')">Focus</div>
        <div class="nav-item" onclick="nav('uplink')">Uplink</div>
        <div class="nav-item" onclick="nav('config')">Sys</div>
    </nav>

    <div id="toast" class="toast">ACKNOWLEDGED</div>

    <script>
        const config = {
            apiKey: "AIzaSyAhgK_yy1gySmtKb6Y6NGbaBvVAk2XaT3A",
            authDomain: "trip-tracker-57ce0.firebaseapp.com",
            databaseURL: "https://trip-tracker-57ce0-default-rtdb.firebaseio.com",
            projectId: "trip-tracker-57ce0",
            storageBucket: "trip-tracker-57ce0.firebasestorage.app",
            messagingSenderId: "236146303848",
            appId: "1:236146303848:web:933f1e79e8a97687db6cdd"
        };

        let db;

        document.addEventListener('DOMContentLoaded', () => {
            // Initialize Firebase
            try {
                const app = firebase.initializeApp(config);
                db = firebase.database();
            } catch (e) {
                console.error("Firebase Init Error", e);
            }

            // Safety timeout for loader
            setTimeout(() => { document.getElementById('loader').style.display = 'none'; }, 1500);

            const role = localStorage.getItem('drs_v3_role');
            if (role) {
                startSession(role);
            } else {
                document.getElementById('view-login').style.display = 'flex';
            }

            // Bind Events
            document.getElementById('login-trigger').onclick = handleLogin;
            document.getElementById('config-save').onclick = saveConfig;
            document.getElementById('gps-trigger').onclick = pushGps;
            document.getElementById('log-trigger').onclick = pushLog;
        });

        function handleLogin() {
            const u = document.getElementById('user-in').value.toLowerCase().trim();
            const p = document.getElementById('pass-in').value.trim();
            const btn = document.getElementById('login-trigger');
            
            btn.innerHTML = "Processing...";
            btn.disabled = true;

            setTimeout(() => {
                if (u === 'watched' && p === '1122') {
                    localStorage.setItem('drs_v3_role', 'traveler');
                    startSession('traveler');
                } else if (u !== '' && p === '1212') {
                    localStorage.setItem('drs_v3_role', 'watcher');
                    startSession('watcher');
                } else {
                    document.getElementById('auth-err').style.display = 'block';
                    btn.innerHTML = "Initialize";
                    btn.disabled = false;
                }
            }, 600);
        }

        function startSession(role) {
            document.querySelectorAll('.view').forEach(v => v.style.display = 'none');
            if (role === 'traveler') {
                nav('home');
                document.getElementById('hud').style.display = 'grid';
                initTraveler();
            } else {
                document.getElementById('view-monitor').style.display = 'block';
                document.getElementById('hud').style.display = 'none';
                initWatcher();
            }
        }

        window.logout = () => { localStorage.clear(); location.reload(); };

        window.nav = (v) => {
            document.querySelectorAll('.view').forEach(view => view.style.display = 'none');
            document.getElementById(`view-${v}`).style.display = 'block';
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            const map = {'home': 0, 'uplink': 1, 'config': 2};
            document.querySelectorAll('.nav-item')[map[v]].classList.add('active');
        };

        // --- TRAVELER LOGIC ---
        function initTraveler() {
            fetchEnv();
            const savedYt = localStorage.getItem('drs_yt');
            if (savedYt) {
                document.getElementById('yt-in').value = savedYt;
                document.getElementById('media-wrap').innerHTML = `<div class="media-box"><iframe src="https://www.youtube.com/embed/videoseries?list=${savedYt}"></iframe></div>`;
            }

            db.ref('trip/alerts').on('value', snap => {
                const zone = document.getElementById('alert-zone');
                zone.innerHTML = '';
                const data = snap.val();
                if (data) {
                    Object.keys(data).forEach(id => {
                        const div = document.createElement('div');
                        div.className = 'drs-card';
                        div.style.borderColor = 'var(--drs-accent)';
                        div.innerHTML = `
                            <span class="label" style="color:var(--drs-accent)">Incoming Priority</span>
                            <div style="font-weight:700; font-size:14px; margin:10px 0;">${data[id].text}</div>
                            <button class="btn btn-primary" style="padding:8px; font-size:9px;" onclick="ackAlert('${id}')">Acknowledge</button>
                        `;
                        zone.appendChild(div);
                    });
                }
            });
        }

        function fetchEnv() {
            navigator.geolocation.getCurrentPosition(async (pos) => {
                try {
                    const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${pos.coords.latitude}&longitude=${pos.coords.longitude}&current_weather=true`);
                    const data = await res.json();
                    document.getElementById('temp-display').innerText = `${Math.round(data.current_weather.temperature)}Â°C`;
                } catch(e) {}
                try {
                    const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${pos.coords.latitude}&lon=${pos.coords.longitude}`);
                    const data = await res.json();
                    document.getElementById('loc-display').innerText = (data.address.city || data.address.town || data.address.village || "TRANSMITTING").toUpperCase();
                } catch(e) {}
            });
        }

        function saveConfig() {
            const id = document.getElementById('yt-in').value.trim();
            localStorage.setItem('drs_yt', id);
            location.reload();
        }

        async function pushGps() {
            const btn = document.getElementById('gps-trigger');
            btn.innerHTML = "READING SAT...";
            navigator.geolocation.getCurrentPosition(async (pos) => {
                const ts = new Date().toISOString();
                await db.ref('trip/location').set({ lat: pos.coords.latitude, lng: pos.coords.longitude, ts });
                await db.ref('trip/logs').push({ text: "SATELLITE_UPLINK_SUCCESS", ts });
                document.getElementById('ping-ts').innerText = "LAST SYNC: " + new Date().toLocaleTimeString();
                btn.innerHTML = "Push Coordinates";
                showToast("COORDINATES SENT");
            });
        }

        async function pushLog() {
            const val = document.getElementById('log-in').value.trim();
            if (!val) return;
            await db.ref('trip/logs').push({ text: val, ts: new Date().toISOString() });
            document.getElementById('log-in').value = '';
            showToast("LOG COMMITTED");
        }

        window.ackAlert = async (id) => { await db.ref(`trip/alerts/${id}`).remove(); };

        // --- WATCHER LOGIC ---
        function initWatcher() {
            db.ref('trip').on('value', snap => {
                const data = snap.val();
                if (!data) return;
                const loc = data.location;
                const logs = data.logs ? Object.values(data.logs).reverse().slice(0, 5) : [];

                let html = `
                    <div class="drs-card">
                        <span class="label">Target Position</span>
                        <h3 style="margin:5px 0; font-size:18px; font-weight:300;">${loc ? `${loc.lat.toFixed(5)}, ${loc.lng.toFixed(5)}` : 'SIGNAL_LOST'}</h3>
                        <p style="font-size:9px; color:var(--drs-text-dim); font-weight:800;">SYNC_REF: ${loc ? new Date(loc.ts).toLocaleTimeString() : '---'}</p>
                        ${loc ? `<a href="https://www.google.com/maps?q=${loc.lat},${loc.lng}" target="_blank" class="btn btn-primary" style="margin-top:20px; text-decoration:none;">Launch Map Trace</a>` : ''}
                    </div>
                    <div class="drs-card">
                        <span class="label">Command Options</span>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                            <button class="btn btn-ghost" style="font-size:9px;" onclick="sendPing('REQUEST_VOICE_CONTACT')">Call Req</button>
                            <button class="btn btn-ghost" style="font-size:9px;" onclick="sendPing('REQUEST_GPS_UPLINK')">Ping Req</button>
                        </div>
                    </div>
                    <div class="drs-card"><span class="label">Log History</span>
                `;
                logs.forEach(l => {
                    html += `<div style="padding:10px 0; border-bottom:1px solid #1a1a1a;">
                        <div style="font-size:11px; font-weight:800; text-transform:uppercase;">${l.text}</div>
                        <div style="font-size:9px; color:#444; margin-top:4px;">${new Date(l.ts).toLocaleTimeString()}</div>
                    </div>`;
                });
                html += '</div>';
                document.getElementById('monitor-stream').innerHTML = html;
            });
        }

        window.sendPing = async (txt) => {
            await db.ref('trip/alerts').push({ text: txt, ts: new Date().toISOString() });
            showToast("CMD SENT");
        };

        function showToast(m) {
            const t = document.getElementById('toast');
            t.innerText = m;
            t.style.display = 'block';
            setTimeout(() => t.style.display = 'none', 2000);
        }
    </script>
</body>
</html>

                
