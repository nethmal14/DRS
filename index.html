<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Liquid Glass OS</title>
    <!-- Tailwind CSS for layout -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Three.js for Shader Background -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap');

        :root {
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --glass-blur: blur(25px) saturate(180%);
        }

        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            overflow: hidden;
            background: #050505;
            color: white;
        }

        #canvas-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }

        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        .input-glass {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 12px 16px;
            color: white;
            outline: none;
            transition: all 0.3s ease;
        }

        .input-glass:focus {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.3);
        }

        .btn-apple {
            background: white;
            color: black;
            font-weight: 500;
            border-radius: 12px;
            padding: 12px 24px;
            transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .btn-apple:active {
            transform: scale(0.96);
        }

        #yt-player-container {
            position: absolute;
            width: 1px;
            height: 1px;
            opacity: 0;
            pointer-events: none;
        }

        .modal-overlay {
            background: rgba(0,0,0,0.4);
            backdrop-filter: blur(10px);
            z-index: 100;
        }

        .hidden-section { display: none !important; }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 10px; }
    </style>
</head>
<body>

    <div id="canvas-container"></div>

    <!-- LOGIN SYSTEM -->
    <div id="login-screen" class="fixed inset-0 flex items-center justify-center z-50">
        <div class="glass-card w-full max-w-md p-10 flex flex-col items-center gap-8 animate-fade-in">
            <div class="w-16 h-16 bg-white/10 rounded-full flex items-center justify-center">
                <i data-lucide="lock" class="text-white/80"></i>
            </div>
            <h1 class="text-3xl font-semibold tracking-tight">Liquid Glass</h1>
            <div class="w-full space-y-4">
                <input type="text" id="username" placeholder="Username" class="input-glass w-full">
                <input type="password" id="password" placeholder="Password" class="input-glass w-full">
            </div>
            <button id="login-btn" class="btn-apple w-full">Unlock Experience</button>
            <p id="login-error" class="text-red-400 text-sm opacity-0 transition-opacity">Invalid credentials</p>
        </div>
    </div>

    <!-- MAIN APP UI -->
    <div id="main-app" class="fixed inset-0 hidden-section flex flex-col p-8">
        <!-- Top Bar -->
        <div class="flex justify-between items-start w-full">
            <div class="glass-card px-6 py-3 flex items-center gap-4">
                <div id="user-avatar" class="w-8 h-8 rounded-full bg-gradient-to-tr from-blue-500 to-purple-500"></div>
                <span id="display-name" class="font-medium opacity-90">User</span>
            </div>
            <button id="browse-btn" class="glass-card p-4 hover:bg-white/10 transition-colors">
                <i data-lucide="search"></i>
            </button>
        </div>

        <!-- Media Control Card -->
        <div class="mt-auto self-center w-full max-w-lg mb-8">
            <div class="glass-card p-6 flex flex-col gap-4 relative">
                <div class="flex items-center gap-4">
                    <div id="track-art" class="w-16 h-16 rounded-xl bg-white/5 flex items-center justify-center overflow-hidden">
                        <i data-lucide="music" class="opacity-20"></i>
                    </div>
                    <div class="flex-1 overflow-hidden">
                        <h2 id="track-title" class="font-semibold truncate">Not Playing</h2>
                        <p id="track-artist" class="text-sm opacity-60 truncate">Add a playlist to start</p>
                    </div>
                    <button id="settings-btn" class="p-2 opacity-60 hover:opacity-100 transition-opacity">
                        <i data-lucide="settings"></i>
                    </button>
                </div>

                <!-- Progress Bar -->
                <div class="w-full bg-white/10 h-1.5 rounded-full overflow-hidden">
                    <div id="progress-bar" class="bg-white/80 h-full w-0 transition-all duration-300"></div>
                </div>

                <!-- Controls -->
                <div class="flex justify-center items-center gap-10">
                    <button id="prev-btn" class="opacity-80 hover:opacity-100 transition-all active:scale-90">
                        <i data-lucide="skip-back" size="24"></i>
                    </button>
                    <button id="play-pause-btn" class="w-14 h-14 bg-white text-black rounded-full flex items-center justify-center hover:scale-105 active:scale-95 transition-all">
                        <i data-lucide="play" fill="black" size="28"></i>
                    </button>
                    <button id="next-btn" class="opacity-80 hover:opacity-100 transition-all active:scale-90">
                        <i data-lucide="skip-forward" size="24"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- BROWSE / PLAYLIST POPUP -->
    <div id="browse-modal" class="fixed inset-0 modal-overlay hidden-section flex items-center justify-center p-6">
        <div class="glass-card w-full max-w-2xl max-h-[80vh] flex flex-col overflow-hidden">
            <div class="p-6 border-b border-white/10 flex justify-between items-center">
                <h3 class="text-xl font-medium">Playlists & Queue</h3>
                <button class="close-modal"><i data-lucide="x"></i></button>
            </div>
            <div class="p-6 flex flex-col gap-6 overflow-y-auto">
                <div class="space-y-2">
                    <label class="text-xs uppercase tracking-widest opacity-50 font-bold">Add New Playlist</label>
                    <div class="flex gap-2">
                        <input type="text" id="playlist-url" placeholder="YouTube Playlist URL" class="input-glass flex-1">
                        <button id="add-playlist-btn" class="btn-apple px-6">Add</button>
                    </div>
                </div>
                <div class="space-y-4">
                    <label class="text-xs uppercase tracking-widest opacity-50 font-bold">Your Library</label>
                    <div id="playlist-list" class="grid grid-cols-1 gap-2">
                        <!-- Playlists go here -->
                        <div class="text-center py-8 opacity-40 italic">No playlists saved yet.</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- SETTINGS POPUP -->
    <div id="settings-modal" class="fixed inset-0 modal-overlay hidden-section flex items-center justify-center p-6">
        <div class="glass-card w-full max-w-md p-6 space-y-8">
            <div class="flex justify-between items-center">
                <h3 class="text-xl font-medium">Shader Settings</h3>
                <button class="close-modal"><i data-lucide="x"></i></button>
            </div>
            
            <div class="space-y-6">
                <div class="space-y-3">
                    <label class="flex justify-between text-sm">
                        <span>Motion Speed</span>
                        <span id="val-speed">1.0</span>
                    </label>
                    <input type="range" id="set-speed" min="0.1" max="5" step="0.1" value="1" class="w-full accent-white">
                </div>

                <div class="space-y-3">
                    <label class="flex justify-between text-sm">
                        <span>Shader Intensity</span>
                        <span id="val-intensity">1.0</span>
                    </label>
                    <input type="range" id="set-intensity" min="0.1" max="3" step="0.1" value="1" class="w-full accent-white">
                </div>

                <div class="space-y-3">
                    <label class="flex justify-between text-sm">
                        <span>Color Shift</span>
                        <span id="val-hue">0°</span>
                    </label>
                    <input type="range" id="set-hue" min="0" max="360" step="1" value="0" class="w-full accent-white">
                </div>

                <div class="flex items-center justify-between">
                    <span class="text-sm">Vignette Layer</span>
                    <input type="checkbox" id="set-vignette" checked class="w-5 h-5 accent-white">
                </div>
            </div>

            <button class="close-modal btn-apple w-full">Done</button>
        </div>
    </div>

    <!-- Hidden YouTube Player -->
    <div id="yt-player-container">
        <div id="player"></div>
    </div>

    <script>
        /**
         * 1. INITIALIZATION & CONFIG
         */
        const firebaseConfig = {
            apiKey: "AIzaSyAhgK_yy1gySmtKb6Y6NGbaBvVAk2XaT3A",
            authDomain: "trip-tracker-57ce0.firebaseapp.com",
            databaseURL: "https://trip-tracker-57ce0-default-rtdb.firebaseio.com",
            projectId: "trip-tracker-57ce0",
            storageBucket: "trip-tracker-57ce0.firebasestorage.app",
            messagingSenderId: "236146303848",
            appId: "1:236146303848:web:933f1e79e8a97687db6cdd",
            measurementId: "G-ZBPCS6QPR5"
        };

        const VALID_USERS = {
            "apple": "apple",
            "orange": "orange",
            "grape": "grape"
        };

        let appState = {
            user: null,
            isPlaying: false,
            currentPlaylistId: null,
            playlistQueue: [],
            currentIndex: 0,
            shaderSettings: {
                speed: 1.0,
                intensity: 1.0,
                hue: 0.0,
                vignette: true
            }
        };

        /**
         * 2. FIREBASE MODULE
         */
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        async function savePlaylist(playlistId) {
            if (!appState.user) return;
            const ref = db.ref(`playlists/${appState.user}`);
            await ref.push({ id: playlistId, addedAt: Date.now() });
            loadPlaylists();
        }

        function loadPlaylists() {
            if (!appState.user) return;
            const ref = db.ref(`playlists/${appState.user}`);
            ref.on('value', (snapshot) => {
                const listEl = document.getElementById('playlist-list');
                listEl.innerHTML = '';
                const data = snapshot.val();
                if (!data) {
                    listEl.innerHTML = `<div class="text-center py-8 opacity-40 italic">No saved playlists.</div>`;
                    return;
                }
                Object.values(data).forEach(pl => {
                    const btn = document.createElement('div');
                    btn.className = 'input-glass flex justify-between items-center hover:bg-white/10 cursor-pointer transition-all';
                    btn.innerHTML = `<span class="truncate">Playlist: ${pl.id}</span> <i data-lucide="play-circle" size="18"></i>`;
                    btn.onclick = () => playPlaylist(pl.id);
                    listEl.appendChild(btn);
                });
                lucide.createIcons();
            });
        }

        /**
         * 3. SHADER BACKGROUND (THREE.JS)
         */
        let scene, camera, renderer, material, mesh;
        const vertexShader = `
            varying vec2 vUv;
            void main() {
                vUv = uv;
                gl_Position = vec4(position, 1.0);
            }
        `;
        const fragmentShader = `
            uniform float time;
            uniform vec2 resolution;
            uniform float intensity;
            uniform float speed;
            uniform float hueShift;
            uniform float isPlaying;
            varying vec2 vUv;

            vec3 hsv2rgb(vec3 c) {
                vec4 K = vec4(1.0, 2.0 / 3.0, 1.0 / 3.0, 3.0);
                vec3 p = abs(fract(c.xxx + K.xyz) * 6.0 - K.www);
                return c.z * mix(K.xxx, clamp(p - K.xxx, 0.0, 1.0), c.y);
            }

            void main() {
                vec2 p = (gl_FragCoord.xy * 2.0 - resolution) / min(resolution.x, resolution.y);
                float t = time * 0.2 * speed;
                
                for(int i=1; i<4; i++){
                    vec2 newp = p;
                    newp.x += 0.5/float(i)*sin(float(i)*p.y+t+cos(t/20.0)*0.5);
                    newp.y += 0.5/float(i)*cos(float(i)*p.x+t+sin(t/30.0)*0.5);
                    p = newp;
                }
                
                float pulse = 0.5 + 0.5 * sin(time * 0.5) * isPlaying;
                vec3 col = 0.5 + 0.5*cos(t + p.xyx + vec3(0,2,4));
                col *= (0.5 + 0.5 * sin(p.x + p.y));
                
                // Interaction with settings
                col *= intensity;
                
                // Hue shift
                vec3 hsv = vec3(hueShift/360.0, 0.6, 0.15); 
                // Mix base liquid color with user hue
                vec3 finalCol = mix(col * 0.2, hsv2rgb(vec3(fract(hueShift/360.0 + col.r*0.2), 0.7, 0.5)), 0.6);
                
                // Vignette
                float dist = length(vUv - 0.5);
                finalCol *= smoothstep(0.8, 0.2, dist * 0.7);

                gl_FragColor = vec4(finalCol, 1.0);
            }
        `;

        function initShader() {
            scene = new THREE.Scene();
            camera = new THREE.Camera();
            camera.position.z = 1;

            const geometry = new THREE.PlaneBufferGeometry(2, 2);
            material = new THREE.ShaderMaterial({
                uniforms: {
                    time: { value: 1.0 },
                    resolution: { value: new THREE.Vector2() },
                    intensity: { value: 1.0 },
                    speed: { value: 1.0 },
                    hueShift: { value: 0.0 },
                    isPlaying: { value: 0.0 }
                },
                vertexShader,
                fragmentShader
            });

            mesh = new THREE.Mesh(geometry, material);
            scene.add(mesh);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setPixelRatio(window.devicePixelRatio);
            document.getElementById('canvas-container').appendChild(renderer.domElement);

            onWindowResize();
            window.addEventListener('resize', onWindowResize);
            animate();
        }

        function onWindowResize() {
            renderer.setSize(window.innerWidth, window.innerHeight);
            material.uniforms.resolution.value.set(window.innerWidth, window.innerHeight);
        }

        function animate() {
            requestAnimationFrame(animate);
            material.uniforms.time.value += 0.01;
            material.uniforms.isPlaying.value = THREE.MathUtils.lerp(material.uniforms.isPlaying.value, appState.isPlaying ? 1.0 : 0.0, 0.05);
            renderer.render(scene, camera);
        }

        /**
         * 4. YOUTUBE PLAYER MODULE
         */
        let player;
        function onYouTubeIframeAPIReady() {
            player = new YT.Player('player', {
                height: '1',
                width: '1',
                videoId: '',
                playerVars: {
                    'autoplay': 0,
                    'controls': 0,
                    'disablekb': 1,
                    'fs': 0,
                    'modestbranding': 1
                },
                events: {
                    'onReady': onPlayerReady,
                    'onStateChange': onPlayerStateChange
                }
            });
        }

        function onPlayerReady(event) {
            console.log("Player Ready");
        }

        function onPlayerStateChange(event) {
            // YT.PlayerState.PLAYING = 1
            if (event.data === YT.PlayerState.PLAYING) {
                appState.isPlaying = true;
                updateUI();
            } else if (event.data === YT.PlayerState.PAUSED || event.data === YT.PlayerState.ENDED) {
                appState.isPlaying = false;
                updateUI();
            }
            
            // Auto update track info when playing starts
            if (event.data === YT.PlayerState.PLAYING) {
                const data = player.getVideoData();
                document.getElementById('track-title').innerText = data.title;
                document.getElementById('track-artist').innerText = data.author || "YouTube Artist";
            }
        }

        function playPlaylist(id) {
            appState.currentPlaylistId = id;
            player.loadPlaylist({
                list: id,
                listType: 'playlist',
                index: 0,
                startSeconds: 0
            });
            document.getElementById('browse-modal').classList.add('hidden-section');
        }

        function togglePlay() {
            if (appState.isPlaying) {
                player.pauseVideo();
            } else {
                player.playVideo();
            }
        }

        /**
         * 5. UI CONTROLS & LOGIC
         */
        function updateUI() {
            const btn = document.getElementById('play-pause-btn');
            btn.innerHTML = appState.isPlaying ? '<i data-lucide="pause" fill="black"></i>' : '<i data-lucide="play" fill="black"></i>';
            lucide.createIcons();
        }

        setInterval(() => {
            if (player && player.getDuration) {
                const dur = player.getDuration();
                const cur = player.getCurrentTime();
                if (dur > 0) {
                    const perc = (cur / dur) * 100;
                    document.getElementById('progress-bar').style.width = perc + '%';
                }
            }
        }, 1000);

        // Login Logic
        document.getElementById('login-btn').addEventListener('click', () => {
            const u = document.getElementById('username').value.toLowerCase();
            const p = document.getElementById('password').value;

            if (VALID_USERS[u] && VALID_USERS[u] === p) {
                appState.user = u;
                document.getElementById('login-screen').classList.add('hidden-section');
                document.getElementById('main-app').classList.remove('hidden-section');
                document.getElementById('display-name').innerText = u.charAt(0).toUpperCase() + u.slice(1);
                loadPlaylists();
            } else {
                const err = document.getElementById('login-error');
                err.style.opacity = '1';
                setTimeout(() => err.style.opacity = '0', 2000);
            }
        });

        // App Navigation
        document.getElementById('browse-btn').addEventListener('click', () => {
            document.getElementById('browse-modal').classList.remove('hidden-section');
        });

        document.getElementById('settings-btn').addEventListener('click', () => {
            document.getElementById('settings-modal').classList.remove('hidden-section');
        });

        document.querySelectorAll('.close-modal').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.modal-overlay').forEach(m => m.classList.add('hidden-section'));
            });
        });

        // Player Buttons
        document.getElementById('play-pause-btn').addEventListener('click', togglePlay);
        document.getElementById('next-btn').addEventListener('click', () => player.nextVideo());
        document.getElementById('prev-btn').addEventListener('click', () => player.previousVideo());

        // Add Playlist
        document.getElementById('add-playlist-btn').addEventListener('click', () => {
            const url = document.getElementById('playlist-url').value;
            const match = url.match(/[?&]list=([^#\&\?]+)/);
            if (match && match[1]) {
                savePlaylist(match[1]);
                document.getElementById('playlist-url').value = '';
            }
        });

        // Settings Listeners
        document.getElementById('set-speed').addEventListener('input', (e) => {
            const v = parseFloat(e.target.value);
            material.uniforms.speed.value = v;
            document.getElementById('val-speed').innerText = v.toFixed(1);
        });

        document.getElementById('set-intensity').addEventListener('input', (e) => {
            const v = parseFloat(e.target.value);
            material.uniforms.intensity.value = v;
            document.getElementById('val-intensity').innerText = v.toFixed(1);
        });

        document.getElementById('set-hue').addEventListener('input', (e) => {
            const v = parseInt(e.target.value);
            material.uniforms.hueShift.value = v;
            document.getElementById('val-hue').innerText = v + '°';
        });

        // Load YT API
        const tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        const firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        // Init App
        window.onload = () => {
            initShader();
            lucide.createIcons();
            
            // Request permissions for extensibility
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia({ audio: true }).catch(e => console.log("Microphone access declined."));
            }
        };

    </script>
</body>
</html>
