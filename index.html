<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sonic Fluid</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        :root {
            --glass-bg: rgba(255, 255, 255, 0.02);
            --glass-border: rgba(255, 255, 255, 0.08);
            --liquid-glow: rgba(255, 255, 255, 0.15);
        }

        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            overflow: hidden; background: #000;
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif;
            color: white; user-select: none; touch-action: none;
        }

        #canvas-bg {
            position: fixed; inset: 0; z-index: 0;
            filter: blur(70px) saturate(2);
            opacity: 0.85;
        }

        /* Fluid Glass Panels */
        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(40px) saturate(180%);
            -webkit-backdrop-filter: blur(40px) saturate(180%);
            border: 1px solid var(--glass-border);
            border-radius: 48px;
            box-shadow: 0 30px 60px -12px rgba(0, 0, 0, 0.8);
            transition: 
                backdrop-filter 0.5s ease, 
                border-color 0.5s ease, 
                box-shadow 0.5s ease, 
                transform 0.5s cubic-bezier(0.2, 0.8, 0.2, 1);
            will-change: backdrop-filter, transform;
        }

        /* Reactive Surface Effect */
        .reactive-surface {
            position: relative;
            overflow: hidden;
        }

        /* The Glow follow */
        .proximity-glow {
            position: absolute;
            width: 300px;
            height: 300px;
            background: radial-gradient(circle, var(--liquid-glow) 0%, transparent 70%);
            pointer-events: none;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            opacity: 0;
            transition: opacity 0.4s ease;
            z-index: 1;
        }

        .input-glass {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.05);
            border-radius: 26px;
            padding: 18px 24px;
            outline: none;
            width: 100%;
            color: white;
            transition: all 0.4s ease;
            font-size: 15px;
        }

        .input-glass:focus {
            background: rgba(255,255,255,0.08);
            border-color: rgba(255,255,255,0.3);
        }

        #btn-play {
            position: relative;
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.1);
            transition: all 0.6s cubic-bezier(0.16, 1, 0.3, 1);
            z-index: 2;
        }

        .ripple {
            position: absolute;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            transform: scale(0);
            animation: fluid-ripple 1.2s cubic-bezier(0, 0.2, 0.5, 1);
            pointer-events: none;
        }

        @keyframes fluid-ripple {
            to { transform: scale(8); opacity: 0; }
        }

        #youtube-player { position: absolute; visibility: hidden; }

        .expandable {
            max-height: 0; opacity: 0; overflow: hidden;
            transition: all 0.8s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .expandable.open { max-height: 450px; opacity: 1; margin-top: 2rem; }

        /* Liquid Slider */
        .liquid-slider {
            -webkit-appearance: none; width: 100%; height: 2px;
            background: rgba(255,255,255,0.1); border-radius: 1px;
            cursor: pointer; position: relative;
        }
        .liquid-slider::-webkit-slider-thumb {
            -webkit-appearance: none; width: 24px; height: 24px;
            background: #fff; border-radius: 50%;
            box-shadow: 0 0 25px rgba(255,255,255,0.6);
            border: 6px solid #000;
        }

        /* Typography */
        .tracking-ultra { letter-spacing: 0.6em; }
    </style>
</head>
<body>

    <canvas id="canvas-bg"></canvas>
    <div id="youtube-player"></div>

    <!-- Auth Layer -->
    <div id="auth-layer" class="fixed inset-0 z-50 flex items-center justify-center bg-black transition-all duration-1000">
        <div class="glass-panel p-12 w-full max-w-sm mx-4 space-y-10 text-center reactive-surface">
            <div class="proximity-glow"></div>
            <div class="space-y-3">
                <h1 class="text-5xl font-extralight tracking-ultra">FLUID</h1>
                <p class="text-[9px] tracking-ultra text-white/20 uppercase">Core Audio Interface</p>
            </div>
            <div class="space-y-4">
                <input id="auth-name" type="text" placeholder="Identity" class="input-glass">
                <input id="auth-pswd" type="password" placeholder="Pass-key" class="input-glass">
            </div>
            <button id="btn-login" class="w-full py-5 glass-panel bg-white/5 border-white/20 text-[10px] tracking-ultra uppercase hover:bg-white/10">Synchronize</button>
            <p id="auth-error" class="text-[10px] text-white/30 font-mono h-2"></p>
        </div>
    </div>

    <!-- Player Interface -->
    <div id="main-player" class="fixed inset-0 flex flex-col items-center justify-center p-6 opacity-0 pointer-events-none transition-all duration-1000 scale-105">
        
        <div class="text-center mb-16 space-y-4">
            <h2 id="track-title" class="text-4xl font-light tracking-tight px-6 truncate max-w-xs md:max-w-md">Surface Static</h2>
            <div class="flex items-center justify-center space-x-2">
                <span id="status-dot" class="w-1 h-1 rounded-full bg-white/20"></span>
                <p id="status-label" class="text-[9px] tracking-ultra text-white/20 uppercase">Atmosphere Ready</p>
            </div>
        </div>

        <div id="player-card" class="glass-panel w-full max-w-md p-10 space-y-12 reactive-surface">
            <div class="proximity-glow"></div>
            
            <!-- Controls -->
            <div class="flex items-center justify-between px-4">
                <button id="btn-prev" class="p-4 text-white/20 hover:text-white transition-colors">
                    <svg width="24" height="24" fill="currentColor"><path d="M6 6h2v12H6V6zm3.5 6L18 6v12l-8.5-6z"/></svg>
                </button>
                <button id="btn-play" class="w-24 h-24 rounded-full flex items-center justify-center shadow-2xl">
                    <svg id="play-icon" width="32" height="32" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                </button>
                <button id="btn-next" class="p-4 text-white/20 hover:text-white transition-colors">
                    <svg width="24" height="24" fill="currentColor"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg>
                </button>
            </div>

            <!-- Seek -->
            <div class="space-y-4">
                <input type="range" id="seek-bar" class="liquid-slider" value="0">
                <div class="flex justify-between text-[9px] font-mono text-white/15">
                    <span id="cur-time">00:00</span>
                    <span id="dur-time">00:00</span>
                </div>
            </div>

            <!-- Archive Expandable -->
            <div class="relative z-10">
                <button id="btn-expand" class="w-full text-[9px] tracking-ultra text-white/10 py-3 border-t border-white/5 transition-colors hover:text-white/40">ARCHIVE</button>
                <div id="playlist-area" class="expandable space-y-6">
                    <div id="playlist-list" class="space-y-3 max-h-40 overflow-y-auto pr-2 scrollbar-hide"></div>
                    <div class="flex gap-2">
                        <input id="yt-url" type="text" placeholder="YouTube List URL" class="input-glass py-3 text-[10px]">
                        <button id="btn-add" class="glass-panel w-12 h-12 flex-shrink-0 flex items-center justify-center text-xl hover:bg-white/10">+</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAhgK_yy1gySmtKb6Y6NGbaBvVAk2XaT3A",
            authDomain: "trip-tracker-57ce0.firebaseapp.com",
            projectId: "trip-tracker-57ce0",
            appId: "1:236146303848:web:933f1e79e8a97687db6cdd"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const APP_ID = "sonic_fluid_v1";

        let player, isPlaying = false, currentUser = null;
        let pointer = { x: -1000, y: -1000 };

        // Background Logic
        const canvas = document.getElementById('canvas-bg');
        const ctx = canvas.getContext('2d');
        const clouds = Array(6).fill().map(() => ({
            x: Math.random() * innerWidth, y: Math.random() * innerHeight,
            r: 350 + Math.random() * 300, vx: (Math.random()-0.5)*0.3, vy: (Math.random()-0.5)*0.3,
            hue: Math.random() * 360
        }));

        function draw() {
            ctx.fillStyle = '#000';
            ctx.fillRect(0,0,canvas.width,canvas.height);
            const beat = isPlaying ? (Math.sin(Date.now()*0.004)*30) : 0;
            
            clouds.forEach(c => {
                c.x += c.vx; c.y += c.vy;
                if(c.x<0 || c.x>innerWidth) c.vx*=-1;
                if(c.y<0 || c.y>innerHeight) b.vy*=-1;

                const g = ctx.createRadialGradient(c.x, c.y, 0, c.x, c.y, c.r + beat);
                g.addColorStop(0, `hsla(${c.hue}, 60%, 50%, 0.2)`);
                g.addColorStop(1, 'transparent');
                ctx.fillStyle = g; ctx.beginPath(); ctx.arc(c.x, c.y, c.r + beat, 0, Math.PI*2); ctx.fill();
            });
            requestAnimationFrame(draw);
        }
        canvas.width = innerWidth; canvas.height = innerHeight;
        draw();

        // Fluid Proximity Engine (Non-Magnetic)
        function handleProximity() {
            const surfaces = document.querySelectorAll('.reactive-surface');
            surfaces.forEach(surface => {
                const glow = surface.querySelector('.proximity-glow');
                const rect = surface.getBoundingClientRect();
                
                // If pointer is inside or near the surface
                const margin = 100;
                if (pointer.x > rect.left - margin && pointer.x < rect.right + margin &&
                    pointer.y > rect.top - margin && pointer.y < rect.bottom + margin) {
                    
                    const localX = pointer.x - rect.left;
                    const localY = pointer.y - rect.top;
                    
                    if (glow) {
                        glow.style.opacity = '1';
                        glow.style.left = localX + 'px';
                        glow.style.top = localY + 'px';
                    }

                    // Pressure Warp: Scale the panel subtly based on closeness to center
                    const centerX = rect.width / 2;
                    const centerY = rect.height / 2;
                    const distToCenter = Math.sqrt(Math.pow(localX - centerX, 2) + Math.pow(localY - centerY, 2));
                    const maxDist = Math.sqrt(Math.pow(centerX, 2) + Math.pow(centerY, 2));
                    const pressure = 1 - (distToCenter / maxDist);
                    
                    surface.style.transform = `scale(${1 + pressure * 0.02})`;
                    surface.style.backdropFilter = `blur(${40 + pressure * 20}px) saturate(${180 + pressure * 50}%)`;
                } else {
                    if (glow) glow.style.opacity = '0';
                    surface.style.transform = `scale(1)`;
                    surface.style.backdropFilter = `blur(40px) saturate(180%)`;
                }
            });
            requestAnimationFrame(handleProximity);
        }
        handleProximity();

        // Pointer Update
        const updatePointer = (e) => {
            const p = e.touches ? e.touches[0] : e;
            pointer.x = p.clientX;
            pointer.y = p.clientY;
        };
        window.addEventListener('mousemove', updatePointer);
        window.addEventListener('touchstart', updatePointer);
        window.addEventListener('touchmove', updatePointer);
        window.addEventListener('touchend', () => { pointer.x = -1000; pointer.y = -1000; });

        // Auth
        document.getElementById('btn-login').onclick = async () => {
            const name = document.getElementById('auth-name').value.trim();
            const pswd = document.getElementById('auth-pswd').value;
            const err = document.getElementById('auth-error');
            if(!name || pswd.length < 6) { err.innerText = "Access sequence invalid"; return; }
            
            const email = `${name.toLowerCase()}@sonic.local`;
            try {
                await auth.signInWithEmailAndPassword(email, pswd);
            } catch (e) {
                if (e.code === 'auth/user-not-found' || e.code === 'auth/invalid-credential') {
                    try {
                        await auth.createUserWithEmailAndPassword(email, pswd);
                    } catch (regE) { err.innerText = "Registry blocked"; }
                } else { err.innerText = "Key rejection"; }
            }
        };

        auth.onAuthStateChanged(async (user) => {
            if(user) {
                currentUser = user;
                const al = document.getElementById('auth-layer');
                al.style.opacity = '0';
                setTimeout(() => {
                    al.style.display = 'none';
                    const main = document.getElementById('main-player');
                    main.classList.remove('pointer-events-none');
                    main.style.opacity = '1'; main.style.transform = 'scale(1)';
                }, 1000);

                const ref = db.collection('artifacts').doc(APP_ID).collection('users').doc(user.uid);
                const snap = await ref.get();
                if(!snap.exists) await ref.set({ playlists: [] });
                ref.onSnapshot(s => renderPlaylists(s.data()?.playlists || []));
            }
        });

        // Audio
        window.onYouTubeIframeAPIReady = () => {
            player = new YT.Player('youtube-player', {
                events: { 
                    'onStateChange': (e) => {
                        isPlaying = e.data === YT.PlayerState.PLAYING;
                        document.getElementById('play-icon').innerHTML = isPlaying ? 
                            `<path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>` : `<path d="M8 5v14l11-7z"/>`;
                        if(isPlaying) document.getElementById('track-title').innerText = player.getVideoData().title;
                    },
                    'onReady': () => setInterval(tick, 500)
                }
            });
        };

        function tick() {
            if(player?.getCurrentTime) {
                const cur = player.getCurrentTime(), dur = player.getDuration();
                document.getElementById('seek-bar').value = (cur/dur)*100 || 0;
                document.getElementById('cur-time').innerText = fmt(cur);
                document.getElementById('dur-time').innerText = fmt(dur);
            }
        }
        const fmt = s => `${Math.floor(s/60)}:${Math.floor(s%60).toString().padStart(2,'0')}`;

        document.getElementById('btn-add').onclick = async () => {
            const url = document.getElementById('yt-url').value;
            const lid = url.match(/[&?]list=([^&]+)/)?.[1];
            if(!lid) return;
            await db.collection('artifacts').doc(APP_ID).collection('users').doc(currentUser.uid)
                  .update({ playlists: firebase.firestore.FieldValue.arrayUnion({ id: lid, name: "Flow "+Date.now().toString().slice(-4) }) });
            document.getElementById('yt-url').value = "";
        };

        function renderPlaylists(pls) {
            const list = document.getElementById('playlist-list');
            list.innerHTML = "";
            pls.forEach(p => {
                const d = document.createElement('div');
                d.className = "glass-panel px-6 py-4 flex justify-between items-center bg-white/5 hover:bg-white/10 cursor-pointer text-[10px] tracking-widest uppercase";
                d.innerHTML = `<span class="truncate">${p.name}</span><span class="del opacity-20">Ã—</span>`;
                d.onclick = (e) => {
                    if(e.target.classList.contains('del')) {
                        db.collection('artifacts').doc(APP_ID).collection('users').doc(currentUser.uid)
                          .update({ playlists: firebase.firestore.FieldValue.arrayRemove(p) });
                    } else {
                        player.loadPlaylist({ list: p.id, listType: 'playlist' });
                    }
                };
                list.appendChild(d);
            });
        }

        // Global Events
        document.getElementById('btn-play').onclick = () => isPlaying ? player.pauseVideo() : player.playVideo();
        document.getElementById('btn-next').onclick = () => player.nextVideo();
        document.getElementById('btn-prev').onclick = () => player.previousVideo();
        document.getElementById('btn-expand').onclick = () => document.getElementById('playlist-area').classList.toggle('open');
        document.getElementById('seek-bar').oninput = (e) => player.seekTo((e.target.value/100)*player.getDuration());

        window.addEventListener('mousedown', (e) => {
            const r = document.createElement('div');
            r.className = 'ripple';
            r.style.left = e.clientX + 'px'; r.style.top = e.clientY + 'px';
            r.style.width = r.style.height = '40px';
            document.body.appendChild(r);
            setTimeout(() => r.remove(), 1200);
        });

        const tag = document.createElement('script'); tag.src = "https://www.youtube.com/iframe_api";
        document.head.appendChild(tag);
    </script>
</body>
</html>

