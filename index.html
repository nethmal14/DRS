<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Liquid Glass Music</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js"></script>
    <style>
        :root {
            --glass-bg: rgba(255, 255, 255, 0.04);
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            overflow: hidden; background: #020202;
            font-family: -apple-system, system-ui, sans-serif;
            color: white; user-select: none;
        }

        #canvas-bg {
            position: fixed; inset: 0; z-index: 0;
            filter: blur(80px) saturate(1.5);
            opacity: 0.7;
        }

        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(40px) saturate(200%);
            -webkit-backdrop-filter: blur(40px) saturate(200%);
            border: 1px solid var(--glass-border);
            border-radius: 44px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5), inset 0 0 0 1px rgba(255,255,255,0.05);
        }

        .input-glass {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 20px;
            padding: 14px 20px;
            outline: none;
            transition: all 0.3s;
            width: 100%;
            color: white;
        }

        .input-glass:focus {
            background: rgba(255,255,255,0.08);
            border-color: rgba(255,255,255,0.3);
            box-shadow: 0 0 20px rgba(255,255,255,0.05);
        }

        .liquid-button {
            position: relative;
            transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
            overflow: hidden;
            display: flex; align-items: center; justify-content: center;
        }

        .liquid-button:active { transform: scale(0.94); }

        .ripple {
            position: absolute;
            background: radial-gradient(circle, rgba(255,255,255,0.5) 0%, transparent 70%);
            border-radius: 50%;
            pointer-events: none;
            transform: scale(0);
            animation: ripple-animation 0.8s ease-out;
        }

        @keyframes ripple-animation {
            to { transform: scale(4); opacity: 0; }
        }

        .expandable {
            max-height: 0; overflow: hidden; opacity: 0;
            transition: all 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .expandable.open { max-height: 500px; opacity: 1; margin-top: 1.5rem; }

        #youtube-player { position: absolute; left: -9999px; }

        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }

        .liquid-slider {
            -webkit-appearance: none; width: 100%; height: 4px;
            background: rgba(255,255,255,0.1); border-radius: 2px;
        }
        .liquid-slider::-webkit-slider-thumb {
            -webkit-appearance: none; width: 16px; height: 16px;
            background: white; border-radius: 50%; cursor: pointer;
            box-shadow: 0 0 10px rgba(255,255,255,0.8);
        }
    </style>
</head>
<body>

    <canvas id="canvas-bg"></canvas>
    <div id="youtube-player"></div>

    <!-- Auth Layer -->
    <div id="auth-layer" class="fixed inset-0 flex items-center justify-center z-50 transition-all duration-1000 bg-black/40 backdrop-blur-md">
        <div class="glass-panel p-10 text-center max-w-sm w-full mx-4 space-y-6">
            <h1 class="text-3xl font-thin tracking-widest uppercase">Sonic Glass</h1>
            <div class="space-y-4">
                <input id="auth-name" type="text" placeholder="Your Name" class="input-glass">
                <input id="auth-pswd" type="password" placeholder="Password" class="input-glass">
            </div>
            <button id="btn-login-action" class="liquid-button w-full py-4 glass-panel bg-white/5 border-white/20 hover:bg-white/10 tracking-[0.3em]">GET IN</button>
            <p id="auth-msg" class="text-xs text-white/40 h-4"></p>
        </div>
    </div>

    <!-- Main Player UI -->
    <div id="main-player" class="fixed inset-0 flex flex-col items-center justify-center p-6 opacity-0 pointer-events-none transition-all duration-1000 scale-95">
        
        <div class="text-center mb-12 w-full">
            <h2 id="track-title" class="text-4xl font-light tracking-tight truncate px-4">Silent Stream</h2>
            <p id="playlist-name" class="text-white/30 text-xs mt-3 tracking-[0.4em] uppercase">Connect to Flow</p>
        </div>

        <div class="glass-panel w-full max-w-md p-10 relative overflow-hidden">
            <!-- Controls -->
            <div class="flex items-center justify-around mb-10">
                <button id="btn-prev" class="liquid-button p-4 text-white/40">
                    <svg width="24" height="24" fill="currentColor"><path d="M6 6h2v12H6V6zm3.5 6L18 6v12l-8.5-6z"/></svg>
                </button>
                <button id="btn-play" class="liquid-button w-24 h-24 glass-panel bg-white/5 border-white/20 shadow-2xl">
                    <svg id="play-icon" width="36" height="36" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                </button>
                <button id="btn-next" class="liquid-button p-4 text-white/40">
                    <svg width="24" height="24" fill="currentColor"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg>
                </button>
            </div>

            <!-- Progress -->
            <div class="space-y-3">
                <input type="range" id="seek-bar" class="liquid-slider" value="0" step="1">
                <div class="flex justify-between text-[10px] text-white/20 font-mono tracking-widest">
                    <span id="current-time">00:00</span>
                    <span id="total-duration">00:00</span>
                </div>
            </div>

            <!-- Playlists Section -->
            <div class="mt-8">
                <button id="toggle-playlists" class="w-full text-[10px] tracking-[0.5em] text-white/20 py-4 border-t border-white/5">ARCHIVE</button>
                <div id="playlist-container" class="expandable space-y-4">
                    <div id="playlist-list" class="max-h-32 overflow-y-auto space-y-2 pr-2 custom-scrollbar"></div>
                    <div class="flex gap-2">
                        <input id="input-yt-url" type="text" placeholder="YouTube URL" class="input-glass text-xs py-3">
                        <button id="btn-add-playlist" class="w-12 h-12 glass-panel flex-shrink-0 flex items-center justify-center text-xl">+</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, arrayUnion, arrayRemove, onSnapshot } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAhgK_yy1gySmtKb6Y6NGbaBvVAk2XaT3A",
            authDomain: "trip-tracker-57ce0.firebaseapp.com",
            projectId: "trip-tracker-57ce0",
            appId: "1:236146303848:web:933f1e79e8a97687db6cdd"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const APP_ID = "sonic-glass-v1";

        let player, currentUser, isPlaying = false, analyzerData;

        // Visualizer Setup
        const canvas = document.getElementById('canvas-bg');
        const ctx = canvas.getContext('2d');
        const circles = Array(6).fill().map(() => ({
            x: Math.random() * innerWidth, y: Math.random() * innerHeight,
            r: Math.random() * 200 + 150, vx: Math.random() - 0.5, vy: Math.random() - 0.5,
            c: `hsla(${Math.random()*360}, 60%, 40%, 0.4)`
        }));

        function animate() {
            ctx.fillStyle = 'rgba(2,2,2,0.15)';
            ctx.fillRect(0,0,canvas.width,canvas.height);
            let pulse = isPlaying ? (Math.sin(Date.now()*0.002)*20 + 10) : 0;
            circles.forEach(c => {
                c.x += c.vx; c.y += c.vy;
                if(c.x < 0 || c.x > canvas.width) c.vx *= -1;
                if(c.y < 0 || c.y > canvas.height) c.vy *= -1;
                const g = ctx.createRadialGradient(c.x, c.y, 0, c.x, c.y, c.r + pulse);
                g.addColorStop(0, c.c); g.addColorStop(1, 'transparent');
                ctx.fillStyle = g; ctx.beginPath(); ctx.arc(c.x,c.y,c.r + pulse,0,Math.PI*2); ctx.fill();
            });
            requestAnimationFrame(animate);
        }
        window.addEventListener('resize', () => { canvas.width = innerWidth; canvas.height = innerHeight; });
        canvas.width = innerWidth; canvas.height = innerHeight;
        animate();

        // Auth: Name + Pswd Logic (Map Name to a fake email)
        document.getElementById('btn-login-action').onclick = async () => {
            const name = document.getElementById('auth-name').value.trim().toLowerCase();
            const pswd = document.getElementById('auth-pswd').value;
            const msg = document.getElementById('auth-msg');
            if(!name || pswd.length < 6) { msg.innerText = "Check name & password (min 6)"; return; }

            const email = `${name}@sonicglass.app`;
            try {
                // Try Login
                await signInWithEmailAndPassword(auth, email, pswd);
            } catch (err) {
                if(err.code === 'auth/user-not-found' || err.code === 'auth/invalid-credential') {
                    // Try Register
                    try {
                        await createUserWithEmailAndPassword(auth, email, pswd);
                    } catch (regErr) { msg.innerText = "Access Denied"; }
                } else { msg.innerText = "Error Connecting"; }
            }
        };

        onAuthStateChanged(auth, async (user) => {
            if(user) {
                currentUser = user;
                document.getElementById('auth-layer').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('auth-layer').classList.add('hidden');
                    const main = document.getElementById('main-player');
                    main.classList.remove('pointer-events-none');
                    main.style.opacity = '1'; main.classList.remove('scale-95');
                }, 1000);

                const userRef = doc(db, 'artifacts', APP_ID, 'users', user.uid);
                const snap = await getDoc(userRef);
                if(!snap.exists()) await setDoc(userRef, { playlists: [] });
                onSnapshot(userRef, (d) => renderPlaylists(d.data()?.playlists || []));
            }
        });

        // YouTube Audio Engine
        window.onYouTubeIframeAPIReady = () => {
            player = new YT.Player('youtube-player', {
                events: { 'onStateChange': onState, 'onReady': () => setInterval(updateUI, 500) }
            });
        };

        function onState(e) {
            isPlaying = (e.data == YT.PlayerState.PLAYING);
            updatePlayIcon();
            if(isPlaying) document.getElementById('track-title').innerText = player.getVideoData().title;
        }

        function updatePlayIcon() {
            document.getElementById('play-icon').innerHTML = isPlaying ? 
                `<path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>` : `<path d="M8 5v14l11-7z"/>`;
        }

        function updateUI() {
            if(player?.getCurrentTime) {
                const cur = player.getCurrentTime(), dur = player.getDuration();
                document.getElementById('seek-bar').value = (cur/dur)*100 || 0;
                document.getElementById('current-time').innerText = format(cur);
                document.getElementById('total-duration').innerText = format(dur);
            }
        }
        const format = s => `${Math.floor(s/60)}:${Math.floor(s%60).toString().padStart(2,'0')}`;

        // Playlist Actions
        async function addPl() {
            const url = document.getElementById('input-yt-url').value;
            const match = url.match(/[&?]list=([^&]+)/);
            if(!match) return;
            await updateDoc(doc(db, 'artifacts', APP_ID, 'users', currentUser.uid), {
                playlists: arrayUnion({ id: match[1], name: "Flow "+Date.now().toString().slice(-4) })
            });
            document.getElementById('input-yt-url').value = "";
        }

        function renderPlaylists(pls) {
            const list = document.getElementById('playlist-list');
            list.innerHTML = "";
            pls.forEach(p => {
                const el = document.createElement('div');
                el.className = "flex justify-between items-center glass-panel px-5 py-3 bg-white/5 hover:bg-white/10 cursor-pointer text-xs tracking-widest";
                el.innerHTML = `<span class="truncate">${p.name}</span><span class="del opacity-20 hover:opacity-100 px-2">Ã—</span>`;
                el.onclick = (e) => {
                    if(e.target.classList.contains('del')) {
                        updateDoc(doc(db, 'artifacts', APP_ID, 'users', currentUser.uid), { playlists: arrayRemove(p) });
                    } else {
                        player.loadPlaylist({ list: p.id, listType: 'playlist' });
                        document.getElementById('playlist-name').innerText = p.name;
                    }
                };
                list.appendChild(el);
            });
        }

        // Logic & Liquid Interactions
        document.getElementById('btn-play').onclick = () => isPlaying ? player.pauseVideo() : player.playVideo();
        document.getElementById('btn-next').onclick = () => player.nextVideo();
        document.getElementById('btn-prev').onclick = () => player.previousVideo();
        document.getElementById('btn-add-playlist').onclick = addPl;
        document.getElementById('toggle-playlists').onclick = () => document.getElementById('playlist-container').classList.toggle('open');
        document.getElementById('seek-bar').oninput = (e) => player.seekTo((e.target.value/100)*player.getDuration());

        window.addEventListener('mousedown', (e) => {
            const ripple = document.createElement('div');
            ripple.className = 'ripple';
            ripple.style.left = e.clientX + 'px';
            ripple.style.top = e.clientY + 'px';
            ripple.style.width = ripple.style.height = '100px';
            document.body.appendChild(ripple);
            setTimeout(() => ripple.remove(), 800);
        });

        // Load YouTube API
        const t = document.createElement('script'); t.src = "https://www.youtube.com/iframe_api";
        document.head.appendChild(t);
    </script>
</body>
</html>

