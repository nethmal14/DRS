<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sonic Fluid</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        :root {
            --glass-bg: rgba(255, 255, 255, 0.02);
            --glass-border: rgba(255, 255, 255, 0.08);
            --liquid-glow: rgba(255, 255, 255, 0.12);
        }

        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            overflow: hidden; background: #000;
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif;
            color: white; user-select: none; touch-action: none;
        }

        #canvas-bg {
            position: fixed; inset: 0; z-index: 0;
            filter: blur(80px) saturate(2.5);
            opacity: 0.9;
        }

        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(40px) saturate(180%);
            -webkit-backdrop-filter: blur(40px) saturate(180%);
            border: 1px solid var(--glass-border);
            border-radius: 48px;
            box-shadow: 0 30px 60px -12px rgba(0, 0, 0, 0.8);
            transition: all 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .reactive-surface { position: relative; overflow: hidden; }

        .proximity-glow {
            position: absolute; width: 350px; height: 350px;
            background: radial-gradient(circle, var(--liquid-glow) 0%, transparent 70%);
            pointer-events: none; border-radius: 50%;
            transform: translate(-50%, -50%); opacity: 0;
            transition: opacity 0.5s ease; z-index: 1;
        }

        .input-glass {
            background: rgba(255,255,255,0.04);
            border: 1px solid rgba(255,255,255,0.06);
            border-radius: 26px;
            padding: 18px 24px;
            outline: none; width: 100%; color: white;
            transition: all 0.4s ease; font-size: 15px;
        }

        .input-glass:focus {
            background: rgba(255,255,255,0.1);
            border-color: rgba(255,255,255,0.3);
        }

        .ripple {
            position: absolute; border-radius: 50%;
            background: rgba(255,255,255,0.15);
            transform: scale(0); animation: fluid-ripple 1.4s cubic-bezier(0.1, 0.2, 0.3, 1);
            pointer-events: none;
        }
        @keyframes fluid-ripple { to { transform: scale(10); opacity: 0; } }

        .expandable {
            max-height: 0; opacity: 0; overflow: hidden;
            transition: all 0.8s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .expandable.open { max-height: 500px; opacity: 1; margin-top: 2rem; }

        .liquid-slider {
            -webkit-appearance: none; width: 100%; height: 2px;
            background: rgba(255,255,255,0.1); border-radius: 1px;
            cursor: pointer;
        }
        .liquid-slider::-webkit-slider-thumb {
            -webkit-appearance: none; width: 24px; height: 24px;
            background: #fff; border-radius: 50%;
            box-shadow: 0 0 20px rgba(255,255,255,0.4); border: 6px solid #000;
        }

        .tracking-ultra { letter-spacing: 0.6em; }
        #youtube-player { position: absolute; visibility: hidden; pointer-events: none; }
        
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body>

    <canvas id="canvas-bg"></canvas>
    <div id="youtube-player"></div>

    <!-- Auth Layer -->
    <div id="auth-layer" class="fixed inset-0 z-50 flex items-center justify-center bg-black transition-all duration-1000">
        <div class="glass-panel p-12 w-full max-w-sm mx-4 space-y-10 text-center reactive-surface">
            <div class="proximity-glow"></div>
            <div class="space-y-3">
                <h1 class="text-5xl font-extralight tracking-ultra">FLUID</h1>
                <p class="text-[9px] tracking-ultra text-white/20 uppercase">Surface Authentication</p>
            </div>
            <div class="space-y-4">
                <input id="auth-name" type="text" placeholder="Identity (e.g. apple)" class="input-glass">
                <input id="auth-pswd" type="password" placeholder="Pass-key" class="input-glass">
            </div>
            <button id="btn-login" class="w-full py-5 glass-panel bg-white/5 border-white/20 text-[10px] tracking-ultra uppercase hover:bg-white/10 active:scale-95 transition-all">Initialize Stream</button>
            <p id="auth-error" class="text-[10px] text-red-500/50 font-mono h-2 mt-2"></p>
        </div>
    </div>

    <!-- Player Interface -->
    <div id="main-player" class="fixed inset-0 flex flex-col items-center justify-center p-6 opacity-0 pointer-events-none transition-all duration-1000 translate-y-8">
        <div class="text-center mb-16 space-y-4">
            <h2 id="track-title" class="text-4xl font-light tracking-tight px-6 truncate max-w-xs md:max-w-md">Surface Static</h2>
            <div class="flex items-center justify-center space-x-2">
                <span id="status-dot" class="w-1 h-1 rounded-full bg-white/20 animate-pulse"></span>
                <p id="status-label" class="text-[9px] tracking-ultra text-white/20 uppercase">Atmosphere Ready</p>
            </div>
        </div>

        <div id="player-card" class="glass-panel w-full max-w-md p-10 space-y-12 reactive-surface">
            <div class="proximity-glow"></div>
            
            <div class="flex items-center justify-between px-4">
                <button id="btn-prev" class="p-4 text-white/20 hover:text-white transition-colors">
                    <svg width="24" height="24" fill="currentColor"><path d="M6 6h2v12H6V6zm3.5 6L18 6v12l-8.5-6z"/></svg>
                </button>
                <button id="btn-play" class="w-24 h-24 rounded-full flex items-center justify-center bg-white/5 border border-white/10 shadow-2xl hover:bg-white/10 active:scale-90 transition-all">
                    <svg id="play-icon" width="32" height="32" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                </button>
                <button id="btn-next" class="p-4 text-white/20 hover:text-white transition-colors">
                    <svg width="24" height="24" fill="currentColor"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg>
                </button>
            </div>

            <div class="space-y-4">
                <input type="range" id="seek-bar" class="liquid-slider" value="0">
                <div class="flex justify-between text-[9px] font-mono text-white/15">
                    <span id="cur-time">00:00</span>
                    <span id="dur-time">00:00</span>
                </div>
            </div>

            <div class="relative z-10">
                <button id="btn-expand" class="w-full text-[9px] tracking-ultra text-white/10 py-3 border-t border-white/5 hover:text-white/40 transition-colors">ARCHIVE</button>
                <div id="playlist-area" class="expandable space-y-6">
                    <div id="playlist-list" class="space-y-3 max-h-40 overflow-y-auto pr-2 scrollbar-hide"></div>
                    <div class="flex gap-2">
                        <input id="yt-url" type="text" placeholder="YouTube List URL" class="input-glass py-3 text-[10px]">
                        <button id="btn-add" class="glass-panel w-12 h-12 flex-shrink-0 flex items-center justify-center text-xl hover:bg-white/10 transition-colors">+</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIG ---
        const STATIC_USERS = [
            { name: 'apple', pswd: 'apple', id: 'user_apple' },
            { name: 'orange', pswd: 'orange', id: 'user_orange' },
            { name: 'grape', pswd: 'grape', id: 'user_grape' }
        ];

        const firebaseConfig = JSON.parse('{"apiKey": "AIzaSyAhgK_yy1gySmtKb6Y6NGbaBvVAk2XaT3A", "authDomain": "trip-tracker-57ce0.firebaseapp.com", "projectId": "trip-tracker-57ce0", "appId": "1:236146303848:web:933f1e79e8a97687db6cdd"}');

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'sonic_fluid_v1';

        let player, isPlaying = false, activeUser = null, unsubscribe = null;
        let pointer = { x: -1000, y: -1000 };

        // --- BACKGROUND CANVAS ---
        const canvas = document.getElementById('canvas-bg');
        const ctx = canvas.getContext('2d');
        const clouds = Array(6).fill().map(() => ({
            x: Math.random() * innerWidth, y: Math.random() * innerHeight,
            r: 350 + Math.random() * 300, vx: (Math.random()-0.5)*0.3, vy: (Math.random()-0.5)*0.3,
            hue: Math.random() * 360
        }));

        function draw() {
            ctx.fillStyle = '#000';
            ctx.fillRect(0,0,canvas.width,canvas.height);
            const beat = isPlaying ? (Math.sin(Date.now()*0.004)*30) : 0;
            clouds.forEach(c => {
                c.x += c.vx; c.y += c.vy;
                if(c.x<0 || c.x>innerWidth) c.vx*=-1;
                if(c.y<0 || c.y>innerHeight) c.vy*=-1;
                const g = ctx.createRadialGradient(c.x, c.y, 0, c.x, c.y, c.r + beat);
                g.addColorStop(0, `hsla(${c.hue}, 60%, 50%, 0.15)`);
                g.addColorStop(1, 'transparent');
                ctx.fillStyle = g; ctx.beginPath(); ctx.arc(c.x, c.y, c.r + beat, 0, Math.PI*2); ctx.fill();
            });
            requestAnimationFrame(draw);
        }
        canvas.width = innerWidth; canvas.height = innerHeight;
        draw();

        // --- UI LOGIC (PROXIMITY) ---
        function handleProximity() {
            const surfaces = document.querySelectorAll('.reactive-surface');
            surfaces.forEach(surface => {
                const glow = surface.querySelector('.proximity-glow');
                const rect = surface.getBoundingClientRect();
                const margin = 100;

                if (pointer.x > rect.left - margin && pointer.x < rect.right + margin &&
                    pointer.y > rect.top - margin && pointer.y < rect.bottom + margin) {
                    
                    const localX = pointer.x - rect.left, localY = pointer.y - rect.top;
                    if (glow) { glow.style.opacity = '1'; glow.style.left = localX + 'px'; glow.style.top = localY + 'px'; }
                    
                    const distToCenter = Math.sqrt(Math.pow(localX-rect.width/2, 2) + Math.pow(localY-rect.height/2, 2));
                    const p = 1 - (distToCenter / (rect.width * 1.2));
                    surface.style.transform = `scale(${1 + Math.max(0, p) * 0.03})`;
                    surface.style.borderColor = `rgba(255,255,255, ${0.08 + Math.max(0, p) * 0.15})`;
                } else {
                    if (glow) glow.style.opacity = '0';
                    surface.style.transform = `scale(1)`;
                    surface.style.borderColor = `rgba(255,255,255,0.08)`;
                }
            });
            requestAnimationFrame(handleProximity);
        }
        handleProximity();

        const updatePointer = (e) => {
            const p = e.touches ? e.touches[0] : e;
            pointer.x = p.clientX; pointer.y = p.clientY;
        };
        window.addEventListener('mousemove', updatePointer);
        window.addEventListener('touchstart', updatePointer);
        window.addEventListener('touchmove', updatePointer);
        window.addEventListener('touchend', () => { pointer.x = -1000; pointer.y = -1000; });

        // --- LOGIN FLOW ---
        document.getElementById('btn-login').onclick = async () => {
            const nameInput = document.getElementById('auth-name').value.trim().toLowerCase();
            const pswdInput = document.getElementById('auth-pswd').value;
            const err = document.getElementById('auth-error');
            
            const match = STATIC_USERS.find(u => u.name === nameInput && u.pswd === pswdInput);
            
            if (match) {
                err.innerText = "INITIALIZING SECURE LINK...";
                try {
                    // Rule 3: Auth Before Queries
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await auth.signInWithCustomToken(__initial_auth_token);
                    } else {
                        await auth.signInAnonymously();
                    }
                    enterApp(match);
                } catch (e) {
                    err.innerText = "ACCESS DENIED: FIREBASE LINK FAILED";
                    console.error("Firebase Auth Error:", e);
                }
            } else {
                err.innerText = "IDENTITY UNKNOWN";
            }
        };

        function enterApp(user) {
            activeUser = user;
            const al = document.getElementById('auth-layer');
            al.style.opacity = '0';
            setTimeout(() => {
                al.style.display = 'none';
                const main = document.getElementById('main-player');
                main.classList.remove('pointer-events-none');
                main.style.opacity = '1'; 
                main.style.transform = 'translateY(0) scale(1)';
            }, 1000);

            // Path rule: /artifacts/{appId}/public/data/{collectionName}
            const ref = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('users').doc(user.id);
            
            // Listen for data
            unsubscribe = ref.onSnapshot(s => {
                if(!s.exists) {
                    ref.set({ playlists: [] });
                } else {
                    renderPlaylists(s.data()?.playlists || []);
                }
            }, (error) => {
                console.error("Firestore Listen Error:", error);
                document.getElementById('auth-error').innerText = "DATA SYNC ERROR";
            });
        }

        // --- YOUTUBE API ---
        window.onYouTubeIframeAPIReady = () => {
            player = new YT.Player('youtube-player', {
                height: '0', width: '0',
                playerVars: { 'autoplay': 0, 'controls': 0 },
                events: { 
                    'onStateChange': (e) => {
                        isPlaying = e.data === YT.PlayerState.PLAYING;
                        const icon = document.getElementById('play-icon');
                        icon.innerHTML = isPlaying ? 
                            `<path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>` : `<path d="M8 5v14l11-7z"/>`;
                        
                        if(isPlaying) {
                            const data = player.getVideoData();
                            document.getElementById('track-title').innerText = data.title || "Flowing...";
                            document.getElementById('status-label').innerText = "Streaming Active";
                            document.getElementById('status-dot').classList.add('bg-blue-400');
                        } else {
                            document.getElementById('status-label').innerText = "Stream Paused";
                            document.getElementById('status-dot').classList.remove('bg-blue-400');
                        }
                    },
                    'onReady': () => {
                        setInterval(tick, 500);
                    }
                }
            });
        };

        function tick() {
            if(player && typeof player.getCurrentTime === 'function') {
                const cur = player.getCurrentTime(), dur = player.getDuration();
                if (dur > 0) {
                    document.getElementById('seek-bar').value = (cur/dur)*100;
                }
                document.getElementById('cur-time').innerText = fmt(cur);
                document.getElementById('dur-time').innerText = fmt(dur);
            }
        }
        const fmt = s => {
            if(!s || isNaN(s)) return "0:00";
            return `${Math.floor(s/60)}:${Math.floor(s%60).toString().padStart(2,'0')}`;
        };

        // --- PLAYLIST OPS ---
        document.getElementById('btn-add').onclick = async () => {
            const url = document.getElementById('yt-url').value;
            const lid = url.match(/[&?]list=([^&]+)/)?.[1];
            if(!lid || !activeUser || !auth.currentUser) return;
            
            const ref = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('users').doc(activeUser.id);
            await ref.update({ 
                playlists: firebase.firestore.FieldValue.arrayUnion({ 
                    id: lid, 
                    name: "Stream " + Math.floor(Math.random()*1000)
                }) 
            });
            document.getElementById('yt-url').value = "";
        };

        function renderPlaylists(pls) {
            const list = document.getElementById('playlist-list');
            list.innerHTML = "";
            if (pls.length === 0) {
                list.innerHTML = `<p class="text-[9px] text-white/10 text-center py-4 tracking-widest">ARCHIVE EMPTY</p>`;
            }
            pls.forEach(p => {
                const d = document.createElement('div');
                d.className = "glass-panel px-6 py-4 flex justify-between items-center bg-white/5 hover:bg-white/10 cursor-pointer text-[10px] tracking-widest uppercase group transition-all";
                d.innerHTML = `<span class="truncate pr-4">${p.name}</span><span class="del opacity-0 group-hover:opacity-40 hover:!opacity-100 transition-opacity">Ã—</span>`;
                d.onclick = (e) => {
                    if(e.target.classList.contains('del')) {
                        const ref = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('users').doc(activeUser.id);
                        ref.update({ playlists: firebase.firestore.FieldValue.arrayRemove(p) });
                    } else { 
                        player.loadPlaylist({ list: p.id, listType: 'playlist', index: 0 }); 
                    }
                };
                list.appendChild(d);
            });
        }

        // --- BUTTON BINDINGS ---
        document.getElementById('btn-play').onclick = () => {
            if (!player) return;
            isPlaying ? player.pauseVideo() : player.playVideo();
        };
        document.getElementById('btn-next').onclick = () => player?.nextVideo();
        document.getElementById('btn-prev').onclick = () => player?.previousVideo();
        document.getElementById('btn-expand').onclick = () => document.getElementById('playlist-area').classList.toggle('open');
        document.getElementById('seek-bar').oninput = (e) => {
            if (player && player.getDuration() > 0) {
                player.seekTo((e.target.value/100)*player.getDuration());
            }
        };

        // Visceral Interaction
        window.addEventListener('mousedown', (e) => {
            const r = document.createElement('div');
            r.className = 'ripple';
            r.style.left = e.clientX + 'px'; r.style.top = e.clientY + 'px';
            r.style.width = r.style.height = '40px';
            document.body.appendChild(r);
            setTimeout(() => r.remove(), 1400);
        });

        // Load API
        const tag = document.createElement('script'); tag.src = "https://www.youtube.com/iframe_api";
        document.head.appendChild(tag);
    </script>
</body>
</html>
